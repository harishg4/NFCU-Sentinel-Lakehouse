name: databricks-cd

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: "Deployment target"
        required: true
        type: choice
        options:
          - dev
          - qa
          - prod
        default: dev
      run_job:
        description: "Trigger sprint1_bronze_orchestration after deploy"
        required: true
        type: boolean
        default: true
      rollback_ref:
        description: "Optional git ref/tag/sha for rollback deploy"
        required: false
        type: string
        default: ""

concurrency:
  group: databricks-cd-${{ github.workflow }}-${{ github.event.inputs.target || 'dev' }}
  cancel-in-progress: false

jobs:
  deploy-dev:
    if: github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'dev')
    runs-on: ubuntu-latest
    environment: dev
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_ref != '' && github.event.inputs.rollback_ref || github.ref }}
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      - name: Validate Auth
        run: |
          [ -n "$DATABRICKS_HOST" ] || (echo "Missing DATABRICKS_HOST secret" && exit 1)
          [ -n "$DATABRICKS_TOKEN" ] || (echo "Missing DATABRICKS_TOKEN secret" && exit 1)
          databricks auth env
      - name: Validate Bundle (dev)
        run: cd orchestration && databricks bundle validate -t dev
      - name: Deploy Bundle (dev)
        run: cd orchestration && databricks bundle deploy -t dev
      - name: Run Workflow (dev)
        if: github.event_name == 'push' || github.event.inputs.run_job == 'true'
        run: cd orchestration && databricks bundle run -t dev sprint1_bronze_orchestration
      - name: Notify Failure (Slack/PagerDuty)
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"Databricks CD failed in dev for ${GITHUB_REPOSITORY} @ ${GITHUB_SHA}\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
          if [ -n "${{ secrets.PAGERDUTY_EVENTS_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"summary\":\"Databricks CD failed in dev\",\"severity\":\"error\",\"source\":\"${GITHUB_REPOSITORY}\"}" \
              "${{ secrets.PAGERDUTY_EVENTS_URL }}"
          fi

  deploy-qa:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'qa'
    runs-on: ubuntu-latest
    environment: qa
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_ref != '' && github.event.inputs.rollback_ref || github.ref }}
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      - name: Validate Auth
        run: |
          [ -n "$DATABRICKS_HOST" ] || (echo "Missing DATABRICKS_HOST secret" && exit 1)
          [ -n "$DATABRICKS_TOKEN" ] || (echo "Missing DATABRICKS_TOKEN secret" && exit 1)
          databricks auth env
      - name: Validate Bundle (qa)
        run: cd orchestration && databricks bundle validate -t qa
      - name: Deploy Bundle (qa)
        run: cd orchestration && databricks bundle deploy -t qa
      - name: Run Workflow (qa)
        if: github.event.inputs.run_job == 'true'
        run: cd orchestration && databricks bundle run -t qa sprint1_bronze_orchestration
      - name: Notify Failure (Slack/PagerDuty)
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"Databricks CD failed in qa for ${GITHUB_REPOSITORY} @ ${GITHUB_SHA}\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
          if [ -n "${{ secrets.PAGERDUTY_EVENTS_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"summary\":\"Databricks CD failed in qa\",\"severity\":\"error\",\"source\":\"${GITHUB_REPOSITORY}\"}" \
              "${{ secrets.PAGERDUTY_EVENTS_URL }}"
          fi

  deploy-prod:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'prod'
    runs-on: ubuntu-latest
    environment: prod
    env:
      DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
      DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.rollback_ref != '' && github.event.inputs.rollback_ref || github.ref }}
      - name: Setup Databricks CLI
        uses: databricks/setup-cli@main
      - name: Validate Auth
        run: |
          [ -n "$DATABRICKS_HOST" ] || (echo "Missing DATABRICKS_HOST secret" && exit 1)
          [ -n "$DATABRICKS_TOKEN" ] || (echo "Missing DATABRICKS_TOKEN secret" && exit 1)
          databricks auth env
      - name: Validate Bundle (prod)
        run: cd orchestration && databricks bundle validate -t prod
      - name: Deploy Bundle (prod)
        run: cd orchestration && databricks bundle deploy -t prod
      - name: Run Workflow (prod)
        if: github.event.inputs.run_job == 'true'
        run: cd orchestration && databricks bundle run -t prod sprint1_bronze_orchestration
      - name: Notify Failure (Slack/PagerDuty)
        if: failure()
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"text\":\"Databricks CD failed in prod for ${GITHUB_REPOSITORY} @ ${GITHUB_SHA}\"}" \
              "${{ secrets.SLACK_WEBHOOK_URL }}"
          fi
          if [ -n "${{ secrets.PAGERDUTY_EVENTS_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{\"summary\":\"Databricks CD failed in prod\",\"severity\":\"critical\",\"source\":\"${GITHUB_REPOSITORY}\"}" \
              "${{ secrets.PAGERDUTY_EVENTS_URL }}"
          fi
